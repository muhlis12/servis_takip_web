{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-4">

    <!-- ÜST ÖZET KARTLARI -->
    <div class="row mb-3">
        <div class="col-md-3 mb-3">
            <div class="card text-bg-primary h-100">
                <div class="card-body">
                    <h6 class="card-title">Öğrenci</h6>
                    <div class="fs-2">
                        {{ summary.student_count }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-bg-success h-100">
                <div class="card-body">
                    <h6 class="card-title">Araç</h6>
                    <div class="fs-2">
                        {{ summary.vehicle_count }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-bg-info h-100">
                <div class="card-body">
                    <h6 class="card-title">Toplam Gelir</h6>
                    <div class="fs-4">
                        {{ "%.2f"|format(summary.total_income) }} TL
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-bg-danger h-100">
                <div class="card-body">
                    <h6 class="card-title">Kar / Zarar</h6>
                    <div class="fs-4">
                        {{ "%.2f"|format(summary.profit) }} TL
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SOL MENÜ SEKME LİSTESİ -->
    <div class="row">
        <div class="col-md-2 mb-3">
            <div class="list-group" id="sidebarTabs" role="tablist">
                <a class="list-group-item list-group-item-action active"
                   id="students-tab"
                   data-bs-toggle="list"
                   href="#students"
                   role="tab">
                    Öğrenciler
                </a>
                <a class="list-group-item list-group-item-action"
                   id="schools-tab"
                   data-bs-toggle="list"
                   href="#schools"
                   role="tab">
                    Okullar
                </a>
                <a class="list-group-item list-group-item-action"
                   id="payments-tab"
                   data-bs-toggle="list"
                   href="#payments"
                   role="tab">
                    Ödemeler
                </a>
                <a class="list-group-item list-group-item-action"
                   id="vehicles-tab"
                   data-bs-toggle="list"
                   href="#vehicles"
                   role="tab">
                    Araçlar
                </a>
                <a class="list-group-item list-group-item-action"
                   id="expenses-tab"
                   data-bs-toggle="list"
                   href="#expenses"
                   role="tab">
                    Giderler
                </a>
            </div>
        </div>

        <!-- SEKME İÇERİKLERİ -->
        <div class="col-md-10">
            <div class="tab-content">

                <!-- ÖĞRENCİLER SEKME -->
                <div class="tab-pane fade show active" id="students" role="tabpanel" aria-labelledby="students-tab">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>Öğrenciler</h5>
                        <input type="text" id="searchStudents" class="form-control w-25"
                               placeholder="Öğrenci / okul ara..."
                               onkeyup="filterTable('tableStudents', this.value)">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-sm" id="tableStudents">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>İsim</th>
                                    <th>Okul</th>
                                    <th>Veli Adı</th>
                                    <th>Telefon</th>
                                    <th>Aylık Ücret</th>
                                    <th>Başlangıç Yılı</th>
                                    <th>Başlangıç Ayı</th>
                                    <th>Aktif</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in students %}
                                <tr>
                                    <td>{{ s[0] }}</td>
                                    <td>{{ s[1] }}</td>
                                    <td>{{ s[2] }}</td>
                                    <td>{{ s[3] }}</td>
                                    <td>{{ s[4] }}</td>
                                    <td>{{ "%.2f"|format(s[5]) }}</td>
                                    <td>{{ s[6] }}</td>
                                    <td>{{ s[7] }}</td>
                                    <td>
                                        {% if s[8] == 1 %}
                                            Aktif
                                        {% else %}
                                            Pasif
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>

                <!-- OKULLAR SEKME -->
                <div class="tab-pane fade" id="schools" role="tabpanel" aria-labelledby="schools-tab">
                    <h5 class="mb-3">Okul İstatistikleri</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Okul</th>
                                    <th>Öğrenci Sayısı</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in school_stats %}
                                <tr>
                                    <td>{{ row[0] }}</td>
                                    <td>{{ row[1] }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ÖDEMELER SEKME -->
                <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payments-tab">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>Ödemeler (son 50)</h5>
                        <input type="text" id="searchPayments" class="form-control w-25"
                               placeholder="Ödeme / öğrenci ara..."
                               onkeyup="filterTable('tablePayments', this.value)">
                    </div>

                    <div class="table-responsive mb-3">
                        <table class="table table-striped table-sm" id="tablePayments">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Öğrenci</th>
                                    <th>Tarih</th>
                                    <th>Tutar</th>
                                    <th>Açıklama</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in payments %}
                                <tr>
                                    <td>{{ p[0] }}</td>  <!-- payments.id -->
                                    <td>{{ p[1] }}</td>  <!-- students.name -->
                                    <td>{{ p[2] }}</td>  <!-- pay_date -->
                                    <td>{{ "%.2f"|format(p[3]) }}</td> <!-- amount -->
                                    <td>{{ p[4] }}</td>  <!-- description -->
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>

                <!-- ARAÇLAR SEKME -->
                <div class="tab-pane fade" id="vehicles" role="tabpanel" aria-labelledby="vehicles-tab">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>Araçlar</h5>
                        <input type="text" id="searchVehicles" class="form-control w-25"
                               placeholder="Plaka / şoför ara..."
                               onkeyup="filterTable('tableVehicles', this.value)">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-sm" id="tableVehicles">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Plaka</th>
                                    <th>Ad</th>
                                    <th>Kapasite</th>
                                    <th>Güzergah</th>
                                    <th>Aktif</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for v in vehicles %}
                                <tr>
                                    <td>{{ v[0] }}</td>
                                    <td>{{ v[1] }}</td>
                                    <td>{{ v[2] }}</td>
                                    <td>{{ v[3] }}</td>
                                    <td>{{ v[4] }}</td>
                                    <td>
                                        {% if v[5] == 1 %}
                                            Aktif
                                        {% else %}
                                            Pasif
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>

                <!-- GİDERLER SEKME -->
                <div class="tab-pane fade" id="expenses" role="tabpanel" aria-labelledby="expenses-tab">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>Giderler (son 50)</h5>
                        <input type="text" id="searchExpenses" class="form-control w-25"
                               placeholder="Kategori / açıklama ara..."
                               onkeyup="filterTable('tableExpenses', this.value)">
                    </div>

                    <div class="table-responsive mb-3">
                        <table class="table table-striped table-sm" id="tableExpenses">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Tarih</th>
                                    <th>Kategori</th>
                                    <th>Tutar</th>
                                    <th>Araç</th>
                                    <th>Açıklama</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for e in expenses %}
                                <tr>
                                    <td>{{ e[0] }}</td>  <!-- id -->
                                    <td>{{ e[1] }}</td>  <!-- exp_date -->
                                    <td>{{ e[2] }}</td>  <!-- category -->
                                    <td>{{ "%.2f"|format(e[3]) }}</td> <!-- amount -->
                                    <td>
                                        {% if e[5] %}
                                            {{ e[5] }} - {{ e[6] }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ e[4] }}</td>  <!-- description -->
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>

<!-- Basit tablo filtreleme -->
<script>
function filterTable(tableId, query) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const filter = query.toLowerCase();
    const rows = table.getElementsByTagName("tr");

    for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let show = false;
        for (let j = 0; j < cells.length; j++) {
            const txt = (cells[j].innerText || "").toLowerCase();
            if (txt.indexOf(filter) !== -1) {
                show = true;
                break;
            }
        }
        rows[i].style.display = show ? "" : "none";
    }
}
</script>

{% endblock %}
