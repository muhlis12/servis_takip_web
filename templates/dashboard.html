{% extends "base.html" %}
{% block content %}

<div class="row mb-3">
  <!-- Özet kartları -->
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h6 class="card-title text-primary">Öğrenci</h6>
        <div class="fs-4">{{ summary.student_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h6 class="card-title text-success">Araç</h6>
        <div class="fs-4">{{ summary.vehicle_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h6 class="card-title text-info">Toplam Gelir</h6>
        <div class="fs-4">{{ "%.2f"|format(summary.total_income) }} TL</div>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h6 class="card-title text-danger">Kâr / Zarar</h6>
        <div class="fs-4">{{ "%.2f"|format(summary.profit) }} TL</div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Sol menü -->
  <div class="col-md-2 mb-3">
    <div class="list-group" id="sidebarTabs" role="tablist">
      <a class="list-group-item list-group-item-action {% if active_tab=='students' %}active{% endif %}"
         data-bs-toggle="list" href="#students" role="tab">
        Öğrenciler
      </a>
      <a class="list-group-item list-group-item-action {% if active_tab=='schools' %}active{% endif %}"
         data-bs-toggle="list" href="#schools" role="tab">
        Okullar
      </a>
      <a class="list-group-item list-group-item-action {% if active_tab=='payments' %}active{% endif %}"
         data-bs-toggle="list" href="#payments" role="tab">
        Ödemeler
      </a>
      <a class="list-group-item list-group-item-action {% if active_tab=='expenses' %}active{% endif %}"
         data-bs-toggle="list" href="#expenses" role="tab">
        Giderler
      </a>
      <a class="list-group-item list-group-item-action {% if active_tab=='vehicles' %}active{% endif %}"
         data-bs-toggle="list" href="#vehicles" role="tab">
        Araç / Hat
      </a>
    </div>
  </div>

  <!-- Sağ içerik -->
  <div class="col-md-10">
    <div class="tab-content">

      <!-- ÖĞRENCİLER TAB -->
      <div class="tab-pane fade {% if active_tab=='students' %}show active{% endif %}" id="students" role="tabpanel">
        <div class="row mb-3">
          <div class="col-md-6">
            <h5>Öğrenci Listesi</h5>
          </div>
          <div class="col-md-6 text-end">
            <input type="text"
                   class="form-control form-control-sm d-inline-block table-search-input"
                   placeholder="Öğrenci / veli / okul ara..."
                   onkeyup="filterTable('tableStudents', this.value)">
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle" id="tableStudents">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Öğrenci</th>
                <th>Okul</th>
                <th>Veli</th>
                <th>Telefon</th>
                <th>Aylık Ücret</th>
                <th>Başlangıç Yılı</th>
                <th>Başlangıç Ayı</th>
                <th>Durum</th>
                <th>İşlem</th>
              </tr>
            </thead>
            <tbody>
              {% for s in students %}
              <tr>
                <td>{{ s[0] }}</td>
                <td>{{ s[1] }}</td>
                <td>{{ s[2] }}</td>
                <td>{{ s[3] }}</td>
                <td>{{ s[4] }}</td>
                <td>{{ "%.2f"|format(s[5]) }}</td>
                <td>{{ s[6] }}</td>
                <td>{{ s[7] }}</td>
                <td>
                  {% if s[8] == 1 %}
                    <span class="badge bg-success">Aktif</span>
                  {% else %}
                    <span class="badge bg-secondary">Pasif</span>
                  {% endif %}
                </td>
                <td>
                  {% if s[8] == 1 %}
                  <form method="post"
                        action="{{ url_for('delete_student', student_id=s[0]) }}"
                        onsubmit="return confirm('Bu öğrenciyi pasife almak istediğinize emin misiniz?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      Pasife Al
                    </button>
                  </form>
                  {% else %}
                    <span class="text-muted">Pasif</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Yeni öğrenci formu -->
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">Yeni Öğrenci</div>
              <div class="card-body">
                <form method="post" action="{{ url_for('add_student') }}">
                  <div class="mb-2">
                    <label class="form-label">Ad Soyad</label>
                    <input type="text" name="name" class="form-control form-control-sm" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Okul</label>
                    <input type="text" name="school" class="form-control form-control-sm">
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Veli Adı</label>
                    <input type="text" name="parent_name" class="form-control form-control-sm">
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Telefon</label>
                    <input type="text" name="phone" class="form-control form-control-sm">
                  </div>
                  <div class="row">
                    <div class="col-md-4 mb-2">
                      <label class="form-label">Aylık Ücret (TL)</label>
                      <input type="text" name="monthly_fee" class="form-control form-control-sm" required>
                    </div>
                    <div class="col-md-4 mb-2">
                      <label class="form-label">Başlangıç Yılı</label>
                      <input type="number" name="start_year" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4 mb-2">
                      <label class="form-label">Başlangıç Ayı</label>
                      <input type="number" name="start_month" class="form-control form-control-sm" min="1" max="12">
                    </div>
                  </div>
                  <div class="mt-2 text-end">
                    <button type="submit" class="btn btn-primary btn-sm">Kaydet</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- OKULLAR TAB -->
      <div class="tab-pane fade {% if active_tab=='schools' %}show active{% endif %}" id="schools" role="tabpanel">
        <div class="row mb-3">
          <div class="col-md-6">
            <h5>Okul Bazlı Öğrenci Sayıları</h5>
          </div>
        </div>

        <div class="table-responsive mb-3">
          <table class="table table-sm table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Okul</th>
                <th>Aktif Öğrenci</th>
              </tr>
            </thead>
            <tbody>
              {% for row in schools_stats %}
              <tr>
                <td>{{ row[0] or '-' }}</td>
                <td>{{ row[1] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="table-responsive">
          <h6>Detaylı Öğrenci Listesi</h6>
          <table class="table table-sm table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Okul</th>
                <th>Öğrenci</th>
                <th>Veli</th>
                <th>Telefon</th>
                <th>Aylık Ücret</th>
                <th>Aktif</th>
              </tr>
            </thead>
            <tbody>
              {% for s in school_students %}
              <tr>
                <td>{{ s[2] }}</td>
                <td>{{ s[1] }}</td>
                <td>{{ s[3] }}</td>
                <td>{{ s[4] }}</td>
                <td>{{ "%.2f"|format(s[5]) }}</td>
                <td>
                  {% if s[6] == 1 %}
                    <span class="badge bg-success">Aktif</span>
                  {% else %}
                    <span class="badge bg-secondary">Pasif</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- ÖDEMELER TAB -->
      <div class="tab-pane fade {% if active_tab=='payments' %}show active{% endif %}" id="payments" role="tabpanel">
        <div class="row mb-3">
          <div class="col-md-6">
            <h5>Ödemeler</h5>
          </div>
          <div class="col-md-6 text-end">
            <input type="text"
                   class="form-control form-control-sm d-inline-block table-search-input"
                   placeholder="Öğrenci / açıklama ara..."
                   onkeyup="filterTable('tablePayments', this.value)">
          </div>
        </div>

        <div class="table-responsive mb-3">
          <table class="table table-sm table-striped align-middle" id="tablePayments">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Öğrenci</th>
                <th>Tarih</th>
                <th>Tutar</th>
                <th>Açıklama</th>
              </tr>
            </thead>
            <tbody>
              {% for p in payments %}
              <tr>
                <td>{{ p[0] }}</td>
                <td>{{ p[1] }}</td>
                <td>{{ p[2] }}</td>
                <td>{{ "%.2f"|format(p[3]) }}</td>
                <td>{{ p[4] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <div class="card">
              <div class="card-header">Yeni Ödeme</div>
              <div class="card-body">
                <form method="post" action="{{ url_for('add_payment') }}">
                  <div class="mb-2">
                    <label class="form-label">Öğrenci</label>
                    <select name="student_id" class="form-select form-select-sm" required>
                      <option value="">Seçiniz...</option>
                      {% for s in students_for_select %}
                      <option value="{{ s[0] }}">{{ s[1] }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tarih</label>
                    <input type="date" name="pay_date" class="form-control form-control-sm" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tutar (TL)</label>
                    <input type="text" name="amount" class="form-control form-control-sm" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Açıklama</label>
                    <input type="text" name="description" class="form-control form-control-sm">
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-sm">Kaydet</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="card">
              <div class="card-header">Tarihe Göre Ödeme</div>
              <div class="card-body">
                <form method="post" action="{{ url_for('payments_by_date') }}">
                  <div class="mb-2">
                    <label class="form-label">Tarih</label>
                    <input type="date" name="filter_date" class="form-control form-control-sm" required>
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-outline-primary btn-sm">Sorgula</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="card">
              <div class="card-header">Günlük Rapor İndir (Excel / PDF)</div>
              <div class="card-body">
                <form method="post" action="{{ url_for('daily_report') }}">
                  <div class="mb-2">
                    <label class="form-label">Tarih</label>
                    <input type="date" name="report_date"
                           class="form-control form-control-sm"
                           value="{{ date_summary.report_date if date_summary else '' }}"
                           required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Format</label>
                    <select name="report_format" class="form-select form-select-sm">
                      <option value="excel">Excel (CSV)</option>
                      <option value="pdf">PDF</option>
                    </select>
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-outline-secondary btn-sm">Rapor İndir</button>
                  </div>
                  <small class="text-muted">
                    Seçilen gün için ödemeler, giderler ve özet bilgiyi
                    Excel (CSV) veya PDF olarak indirebilirsiniz.
                  </small>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- GİDERLER TAB -->
      <div class="tab-pane fade {% if active_tab=='expenses' %}show active{% endif %}" id="expenses" role="tabpanel">
        <div class="row mb-3">
          <div class="col-md-6">
            <h5>Giderler</h5>
          </div>
          <div class="col-md-6 text-end">
            <input type="text"
                   class="form-control form-control-sm d-inline-block table-search-input"
                   placeholder="Kategori / açıklama ara..."
                   onkeyup="filterTable('tableExpenses', this.value)">
          </div>
        </div>

        <div class="table-responsive mb-3">
          <table class="table table-sm table-striped align-middle" id="tableExpenses">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Tarih</th>
                <th>Kategori</th>
                <th>Tutar</th>
                <th>Açıklama</th>
                <th>Araç</th>
              </tr>
            </thead>
            <tbody>
              {% for e in expenses %}
              <tr>
                <td>{{ e[0] }}</td>
                <td>{{ e[1] }}</td>
                <td>{{ e[2] }}</td>
                <td>{{ "%.2f"|format(e[3]) }}</td>
                <td>{{ e[4] }}</td>
                <td>
                  {% if e[5] %}
                    {{ e[5] }} - {{ e[6] or '' }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <div class="card">
              <div class="card-header">Yeni Gider</div>
              <div class="card-body">
                <form method="post" action="{{ url_for('add_expense') }}">
                  <div class="mb-2">
                    <label class="form-label">Araç (opsiyonel)</label>
                    <select name="vehicle_id_exp" class="form-select form-select-sm">
                      <option value="">Genel Gider</option>
                      {% for v in vehicles %}
                      <option value="{{ v[0] }}">{{ v[1] }} - {{ v[2] }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tarih</label>
                    <input type="date" name="exp_date" class="form-control form-control-sm" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Kategori</label>
                    <input type="text" name="category" class="form-control form-control-sm" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tutar (TL)</label>
                    <input type="text" name="amount_exp" class="form-control form-control-sm" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Açıklama</label>
                    <input type="text" name="description_exp" class="form-control form-control-sm">
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-sm">Kaydet</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="card">
              <div class="card-header">Dönemsel Kâr/Zarar</div>
              <div class="card-body">
                <form method="post" action="{{ url_for('profit') }}">
                  <div class="mb-2">
                    <label class="form-label">Başlangıç</label>
                    <input type="date" name="start_date_profit" class="form-control form-control-sm" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Bitiş</label>
                    <input type="date" name="end_date_profit" class="form-control form-control-sm" required>
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-outline-primary btn-sm">Hesapla</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ARAÇ / HAT TAB -->
      <div class="tab-pane fade {% if active_tab=='vehicles' %}show active{% endif %}" id="vehicles" role="tabpanel">
        <div class="row mb-3">
          <div class="col-md-6">
            <h5>Araç / Hat Yönetimi</h5>
          </div>
        </div>

        <div class="table-responsive mb-3">
          <table class="table table-sm table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Plaka</th>
                <th>Şoför</th>
                <th>Kapasite</th>
                <th>Güzergah</th>
                <th>Aktif</th>
                <th>Rapor</th>
              </tr>
            </thead>
            <tbody>
              {% for v in vehicles %}
              <tr>
                <td>{{ v[0] }}</td>
                <td>{{ v[1] }}</td>
                <td>{{ v[2] }}</td>
                <td>{{ v[3] }}</td>
                <td>{{ v[4] }}</td>
                <td>
                  {% if v[5] == 1 %}
                    <span class="badge bg-success">Aktif</span>
                  {% else %}
                    <span class="badge bg-secondary">Pasif</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <a href="{{ url_for('vehicle_report', vehicle_id=v[0], report_format='excel') }}"
                       class="btn btn-outline-primary">Excel</a>
                    <a href="{{ url_for('vehicle_report', vehicle_id=v[0], report_format='pdf') }}"
                       class="btn btn-outline-secondary">PDF</a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-header">Yeni Araç</div>
              <div class="card-body">
                <form method="post" action="{{ url_for('add_vehicle') }}">
                  <div class="mb-2">
                    <label class="form-label">Plaka</label>
                    <input type="text" name="plate" class="form-control form-control-sm" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Şoför Adı</label>
                    <input type="text" name="driver_name" class="form-control form-control-sm">
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Kapasite</label>
                    <input type="number" name="capacity" class="form-control form-control-sm">
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Güzergah</label>
                    <input type="text" name="route" class="form-control form-control-sm">
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-sm">Kaydet</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-header">Öğrenciyi Araca Ata</div>
              <div class="card-body">
                <form method="post" action="{{ url_for('assign_vehicle') }}">
                  <div class="mb-2">
                    <label class="form-label">Öğrenci</label>
                    <select name="student_id_assign" class="form-select form-select-sm" required>
                      <option value="">Seçiniz...</option>
                      {% for s in students_for_select %}
                      <option value="{{ s[0] }}">{{ s[1] }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Araç</label>
                    <select name="vehicle_id_assign" class="form-select form-select-sm" required>
                      <option value="">Seçiniz...</option>
                      {% for v in vehicles %}
                      <option value="{{ v[0] }}">{{ v[1] }} - {{ v[2] }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-sm">Ata</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}
